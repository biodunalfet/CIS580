%% 1.1.4
im = imread('IMG_0196.JPG');
size(im)
f = 4.12;
d = 1237.3*0.0015;
h = (180*12*25.4)*d/f/1000;

%% 1.2.2
Ha = 60;
Hb = 120;
Da = 155;
Db = 315;
f = 4.15;
ha = f*Ha/Da;
hb = f*Hb/Db;
[Ha ha; Hb 1.5*hb]\[ha*Da;1.5*hb*Db];

%% 2.1.1
K = [2810.85150 0 1643.16492;...
    0 2803.50997 1240.43791;...
    0 0 1];

p1 = [ 1829; 1478; 1];
p2 = [ 2477; 2045; 1];
p3 = [ 1868; 902; 1];
p4 = [ 2432; 362; 1];

l12 = cross(p1,p2);
l12 = l12/norm(l12(1:2));
l34 = cross(p3,p4);
l34 = l34/norm(l34(1:2));

x = cross(l12,l34);
x = x/x(3)

X = K\x;
X = X/norm(X);

alpha = atan2(X(1),X(3))*180/pi
beta = asin(X(2))*180/pi

%% 2.1.2
K = [2810.85150 0 1643.16492;...
    0 2803.50997 1240.43791;...
    0 0 1];

% line 1 calculation
p1 = [ 310.2; 1348; 1];
p2 = [ 883.2; 560.4; 1];

% line 2 calculation
p3 = [ 631.9; 1499; 1];
p4 = [ 1331; 460.8; 1];

% line 3 calculation
p5 = [365.2; 1092; 1];
p6 = [1132; 1237; 1];

% line 4 calculation
p7 = [590; 783.8; 1];
p8 = [1474; 681.2; 1];

l12 = cross(p1,p2);
l12 = l12/norm(l12(1:2));
l34 = cross(p3,p4);
l34 = l34/norm(l34(1:2));
l56 = cross(p5,p6);
l56 = l56/norm(l56(1:2));
l78 = cross(p7,p8);
l78 = l78/norm(l78(1:2));

x1 = cross(l12,l34);
x1 = x1/x1(3)
x2 = cross(l56,l78);
x2 = x2/x2(3)

X1 = K\x1;
X1 = X1/norm(X1);
X2 = K\x2;
X2 = X2/norm(X2);
X3 = cross(X1,X2);

R = [X1 X2 X3]
alpha = atan2(X3(1),X3(3));
beta = asin(X3(2));
gamma = atan2(R(2,1),R(1,1));
pan = alpha*180/pi
tilt = beta*180/pi
yaw = gamma*180/pi

%% 2.3.1
H1 = [0.0002 0.0000 -0.0361;...
    0.0000 -0.0001 0.0263;...
    0.0000 0.0002 0.9990]
r11 = H1(:,1)/norm(H1(:,1));
r21 = H1(:,2)/norm(H1(:,2));
r31 = cross(r11,r21);
R1 = [r11 r21 r31]
t1 = H1(:,3)/norm(H1(:,1))

%% 2.3.2
H2 = [0.0002 -0.0000 -0.3891;...
    0.0000 -0.0001 0.0243;...
    0.0000 0.0002 0.9209];

r12 = H2(:,1)/norm(H2(:,1));
r22 = H2(:,2)/norm(H2(:,2));
r32 = cross(r12,r22);
R2 = [r12 r22 r32]
t2 = H2(:,3)/norm(H2(:,1))

%% 2.3.3
P=(R2'*(-t2))-R1'*(-t1)
P*100/2.54/12/1000